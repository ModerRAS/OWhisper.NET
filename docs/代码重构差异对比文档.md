# OWhisper.NET ä»£ç é‡æ„å·®å¼‚å¯¹æ¯”æ–‡æ¡£

## æ¦‚è¿°

åœ¨å°†æ ¸å¿ƒé€»è¾‘ä» OWhisper.NET é¡¹ç›®è¿ç§»åˆ° OWhisper.Core é¡¹ç›®çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€äº›å®ç°å·®å¼‚ã€‚æœ¬æ–‡æ¡£è®°å½•è¿™äº›å·®å¼‚ï¼Œä¸ºåç»­ç»´æŠ¤å’ŒåŠŸèƒ½å¢å¼ºæä¾›å‚è€ƒã€‚

## ä¸»è¦å·®å¼‚å¯¹æ¯”

### 1. WhisperController.cs

#### åŸç‰ˆæœ¬ (OWhisper.NET/WhisperController.cs)
- **å‘½åç©ºé—´**: `OWhisper.NET`
- **ä¾èµ–æ¨¡å‹**: `OWhisper.NET.Models`
- **WhisperManagerå®ä¾‹åŒ–**: `new WhisperManager()` (æ— å‚æ•°æ„é€ )
- **é”™è¯¯æ—¥å¿—**: ä½¿ç”¨ `Console.WriteLine()` è¾“å‡ºé”™è¯¯
- **é˜Ÿåˆ—ä½ç½®å­—æ®µ**: ä½¿ç”¨ `task.QueuePosition` å­—æ®µ
- **è¿”å›å“åº”æ¨¡å‹**: åŒ…å« `TaskCreationResponse` ç±»

#### Coreç‰ˆæœ¬ (OWhisper.Core/Controllers/WhisperController.cs)
- **å‘½åç©ºé—´**: `OWhisper.Core.Controllers`
- **ä¾èµ–æ¨¡å‹**: `OWhisper.Core.Models`
- **WhisperManagerå®ä¾‹åŒ–**: `new WhisperManager(_pathService)` (æ³¨å…¥è·¯å¾„æœåŠ¡)
- **é”™è¯¯æ—¥å¿—**: ä½¿ç”¨ `Log.Error()` ç»“æ„åŒ–æ—¥å¿—
- **é˜Ÿåˆ—ä½ç½®å­—æ®µ**: ä¸´æ—¶ä½¿ç”¨ `task.Progress` å­—æ®µ (éœ€è¦ä¿®å¤)
- **è·¨å¹³å°æ”¯æŒ**: é›†æˆäº† `IPlatformPathService`

**å…³é”®æ”¹è¿›**:
- âœ… æ›´å¥½çš„ä¾èµ–æ³¨å…¥è®¾è®¡
- âœ… ç»“æ„åŒ–æ—¥å¿—è®°å½•
- âš ï¸ **éœ€è¦ä¿®å¤**: é˜Ÿåˆ—ä½ç½®é€»è¾‘ä¸´æ—¶ä½¿ç”¨Progresså­—æ®µ

### 2. TranscriptionTask.cs

#### åŸç‰ˆæœ¬ (OWhisper.NET/Models/TranscriptionTask.cs)
```csharp
public class TranscriptionTask {
    public string Id { get; set; }
    public TaskStatus Status { get; set; }
    public float Progress { get; set; }
    public string FileName { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? StartedAt { get; set; }
    public DateTime? CompletedAt { get; set; }
    public TranscriptionResult Result { get; set; }
    public string ErrorMessage { get; set; }
    public int QueuePosition { get; set; }  // ğŸ”‘ å…³é”®å­—æ®µ
}

public enum TaskStatus {
    Queued,      // åŸç‰ˆæœ¬ä½¿ç”¨
    Processing,
    Completed,
    Failed,
    Cancelled
}

// é¢å¤–åŒ…å«çš„ç±»
public class TranscriptionProgress { ... }
public class TaskCreationResponse { ... }
```

#### Coreç‰ˆæœ¬ (OWhisper.Core/Models/TranscriptionTask.cs)
```csharp
public class TranscriptionTask {
    public string Id { get; set; } = string.Empty;
    public string FileName { get; set; } = string.Empty;
    public string? Language { get; set; }
    public string? Model { get; set; }
    public string? FilePath { get; set; }
    public TaskStatus Status { get; set; }
    public float Progress { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? StartedAt { get; set; }
    public DateTime? CompletedAt { get; set; }
    public TranscriptionResult? Result { get; set; }
    public string? ErrorMessage { get; set; }
    // âŒ ç¼ºå°‘ QueuePosition å­—æ®µ
}

public enum TaskStatus {
    Pending,     // Coreç‰ˆæœ¬ä½¿ç”¨
    Processing,
    Completed,
    Failed,
    Cancelled
}
```

**å…³é”®å·®å¼‚**:
- âŒ **ç¼ºå¤±å­—æ®µ**: `QueuePosition` - è¿™å¯¼è‡´äº†Controllerä¸­çš„ä¸´æ—¶è§£å†³æ–¹æ¡ˆ
- âœ… **å¢å¼ºå­—æ®µ**: æ·»åŠ äº† `Language`, `Model`, `FilePath` æ”¯æŒ
- âš ï¸ **æšä¸¾å·®å¼‚**: `Queued` vs `Pending`
- âœ… **ç±»å‹å®‰å…¨**: ä½¿ç”¨å¯ç©ºç±»å‹æé«˜å®‰å…¨æ€§

### 3. TranscriptionQueueService.cs

#### åŸç‰ˆæœ¬ (OWhisper.NET/TranscriptionQueueService.cs)
- **é˜Ÿåˆ—å®ç°**: ä½¿ç”¨ `Queue<string>` + `lock`
- **éŸ³é¢‘ç¼“å­˜**: `ConcurrentDictionary<string, byte[]> _audioDataCache`
- **è¿›åº¦äº‹ä»¶**: `EventHandler<TranscriptionProgress>`
- **é˜Ÿåˆ—ä½ç½®ç®¡ç†**: å®Œæ•´çš„ `QueuePosition` å­—æ®µç®¡ç†
- **ä»»åŠ¡çŠ¶æ€**: ä½¿ç”¨ `TaskStatus.Queued`

#### Coreç‰ˆæœ¬ (OWhisper.Core/Services/TranscriptionQueueService.cs)
- **é˜Ÿåˆ—å®ç°**: ä½¿ç”¨ `ConcurrentQueue<string>` (çº¿ç¨‹å®‰å…¨)
- **éŸ³é¢‘ç¼“å­˜**: ç®€åŒ–å¤„ç†ï¼Œä½¿ç”¨ä¸´æ—¶æ–‡ä»¶è·¯å¾„
- **è¿›åº¦äº‹ä»¶**: `EventHandler<TranscriptionTask>`
- **é˜Ÿåˆ—ä½ç½®ç®¡ç†**: ä¸´æ—¶ä½¿ç”¨Progresså­—æ®µ (ä¸ç†æƒ³)
- **ä»»åŠ¡çŠ¶æ€**: ä½¿ç”¨ `TaskStatus.Pending`

**å…³é”®æ”¹è¿›ä¸é—®é¢˜**:
- âœ… **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ `ConcurrentQueue` æ›¿ä»£ `Queue` + `lock`
- âœ… **ç°ä»£åŒ–æ¶æ„**: æ›´å¥½çš„å¼‚æ­¥å¤„ç†
- âŒ **åŠŸèƒ½é™çº§**: é˜Ÿåˆ—ä½ç½®ç®¡ç†ä¸å®Œå–„
- âŒ **éŸ³é¢‘ç¼“å­˜**: ç®€åŒ–è¿‡åº¦ï¼Œå¯èƒ½å½±å“æ€§èƒ½

### 4. ApiResponse.cs

#### åŸç‰ˆæœ¬ vs Coreç‰ˆæœ¬
**å®Œå…¨ç›¸åŒ**ï¼Œé™¤äº†å‘½åç©ºé—´å·®å¼‚ï¼š
- åŸç‰ˆæœ¬: `OWhisper.NET.Models`
- Coreç‰ˆæœ¬: `OWhisper.Core.Models`

### 5. SseController.cs

#### ç°çŠ¶
- **ä»…å­˜åœ¨äº**: OWhisper.NETé¡¹ç›®
- **åŠŸèƒ½**: Server-Sent Events (SSE) å®æ—¶è¿›åº¦æ¨é€
- **ä¾èµ–**: `TranscriptionQueueService.ProgressUpdated` äº‹ä»¶

#### è¿ç§»å»ºè®®
**æš‚ä¸åˆ é™¤**ï¼Œéœ€è¦è¯„ä¼°æ˜¯å¦è¿ç§»åˆ°Coreé¡¹ç›®ï¼š
- SSEåŠŸèƒ½å¯¹Webåº”ç”¨å¾ˆé‡è¦
- éœ€è¦é€‚é…Coreç‰ˆæœ¬çš„äº‹ä»¶ç³»ç»Ÿ

## éœ€è¦ä¿®å¤çš„é—®é¢˜

### ğŸ”´ é«˜ä¼˜å…ˆçº§

1. **é˜Ÿåˆ—ä½ç½®å­—æ®µç¼ºå¤±**
   ```csharp
   // éœ€è¦åœ¨ TranscriptionTask ä¸­æ·»åŠ 
   public int QueuePosition { get; set; }
   ```

2. **TranscriptionQueueServiceé˜Ÿåˆ—ä½ç½®é€»è¾‘**
   ```csharp
   // å½“å‰ä¸´æ—¶æ–¹æ¡ˆ (ä¸ç†æƒ³)
   pendingTasks[i].Progress = i + 1; // æš‚æ—¶ç”¨Progresså­—æ®µå­˜å‚¨é˜Ÿåˆ—ä½ç½®
   
   // åº”è¯¥ä¿®å¤ä¸º
   pendingTasks[i].QueuePosition = i + 1;
   ```

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

3. **TaskStatusæšä¸¾ç»Ÿä¸€**
   - å†³å®šä½¿ç”¨ `Queued` è¿˜æ˜¯ `Pending`
   - æ›´æ–°æ‰€æœ‰ç›¸å…³ä»£ç ä¿æŒä¸€è‡´

4. **éŸ³é¢‘æ•°æ®ç¼“å­˜ç­–ç•¥**
   - è¯„ä¼°å½“å‰ç®€åŒ–æ–¹æ¡ˆçš„æ€§èƒ½å½±å“
   - è€ƒè™‘æ¢å¤å†…å­˜ç¼“å­˜æˆ–æ”¹è¿›æ–‡ä»¶ç¼“å­˜

### ğŸŸ¢ ä½ä¼˜å…ˆçº§

5. **SSEæ§åˆ¶å™¨è¿ç§»**
   - è¯„ä¼°æ˜¯å¦éœ€è¦è¿ç§»åˆ°Coreé¡¹ç›®
   - é€‚é…æ–°çš„äº‹ä»¶ç³»ç»Ÿ

## åˆ é™¤è®¡åˆ’

åŸºäºå·®å¼‚åˆ†æï¼Œä»¥ä¸‹æ–‡ä»¶å¯ä»¥å®‰å…¨åˆ é™¤ï¼š

### âœ… å¯ä»¥åˆ é™¤ (åŠŸèƒ½å®Œå…¨è¿ç§»)
- `OWhisper.NET/Models/ApiResponse.cs`
- `OWhisper.NET/Models/TranscriptionResult.cs`
- `OWhisper.NET/Models/AudioProcessingException.cs`
- `OWhisper.NET/WhisperController.cs`
- `OWhisper.NET/AudioProcessor.cs`
- `OWhisper.NET/HttpClientHelper.cs`

### âš ï¸ éœ€è¦ä¿®å¤ååˆ é™¤
- `OWhisper.NET/Models/TranscriptionTask.cs` (éœ€è¦å…ˆä¿®å¤QueuePositionå­—æ®µ)
- `OWhisper.NET/TranscriptionQueueService.cs` (éœ€è¦å…ˆä¿®å¤é˜Ÿåˆ—ä½ç½®é€»è¾‘)

### ğŸ” éœ€è¦è¯„ä¼°
- `OWhisper.NET/SseController.cs` (è¯„ä¼°æ˜¯å¦è¿ç§»åˆ°Core)

## å»ºè®®çš„ä¿®å¤é¡ºåº

1. **ç«‹å³ä¿®å¤**: åœ¨Coreç‰ˆæœ¬ä¸­æ·»åŠ QueuePositionå­—æ®µ
2. **ç«‹å³ä¿®å¤**: ä¿®å¤TranscriptionQueueServiceçš„é˜Ÿåˆ—ä½ç½®é€»è¾‘
3. **æµ‹è¯•éªŒè¯**: ç¡®ä¿CLIå’Œæ¡Œé¢ç‰ˆåŠŸèƒ½ä¸€è‡´
4. **åˆ é™¤é‡å¤æ–‡ä»¶**: æŒ‰ç…§ä¸Šè¿°è®¡åˆ’åˆ é™¤
5. **åŠŸèƒ½å¢å¼º**: è€ƒè™‘SSEæ§åˆ¶å™¨è¿ç§»

## æ€»ç»“

é‡æ„æ•´ä½“æˆåŠŸï¼Œå®ç°äº†ä»£ç å¤ç”¨å’Œè·¨å¹³å°æ”¯æŒçš„ç›®æ ‡ã€‚ä¸»è¦é—®é¢˜é›†ä¸­åœ¨é˜Ÿåˆ—ä½ç½®ç®¡ç†çš„å®ç°ç»†èŠ‚ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å¯¹å®¹æ˜“ä¿®å¤çš„é—®é¢˜ã€‚å»ºè®®ä¼˜å…ˆä¿®å¤å…³é”®å­—æ®µç¼ºå¤±é—®é¢˜ï¼Œç„¶åå†è¿›è¡Œæ–‡ä»¶æ¸…ç†ã€‚ 